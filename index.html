<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Lesehan Macca - Menu Lengkap</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-red: #8B1A1A; 
            --primary-grad: linear-gradient(135deg, #8B1A1A 0%, #B20610 100%);
            --bg: #f8f9fa;
            --card: #ffffff;
            --text-dark: #2d3436;
            --radius: 20px;
            --accent-grad: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-dark); padding-bottom: 140px; }

        header {
            background-color: var(--primary-red);
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?auto=format&fit=crop&w=500');
            background-size: cover; background-position: center; padding: 40px 20px; text-align: center;
        }

        .main-logo-text { color: white; font-size: 32px; font-weight: 800; margin: 0; font-style: italic; }
        header p { color: white; opacity: 0.9; margin-top: 5px; font-size: 13px; }

        .tabs-container {
            position: sticky; top: 0; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px); z-index: 100; padding: 12px 0;
            display: flex; gap: 8px; overflow-x: auto; padding-left: 15px;
            border-bottom: 1px solid #eee; scrollbar-width: none;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        
        .tab-link {
            white-space: nowrap; padding: 10px 20px; background: #fff;
            border: 1px solid #eee; border-radius: 50px; font-weight: 700; color: #636e72;
            cursor: pointer; font-size: 13px;
        }
        .tab-link.active { background: var(--primary-red); color: white; border-color: transparent; box-shadow: 0 5px 12px rgba(139, 26, 26, 0.2); }

        .container { max-width: 600px; margin: 0 auto; padding: 10px 15px; }
        .menu-section { display: none; }
        .menu-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { font-size: 16px; font-weight: 800; color: var(--primary-red); margin: 20px 0 10px; border-left: 4px solid var(--primary-red); padding-left: 10px; }

        .menu-card {
            background: var(--card); border-radius: var(--radius); overflow: hidden;
            display: flex; align-items: center; padding: 10px; margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid #f0f0f0;
        }
        .product-img { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; background: #f5f5f5; flex-shrink: 0; }
        .menu-info { flex: 1; padding: 0 12px; }
        .menu-info h4 { margin: 0 0 2px; font-size: 13px; font-weight: 700; color: #333; line-height: 1.2; }
        .menu-info p { margin: 0; font-size: 14px; color: var(--primary-red); font-weight: 800; }
        .add-btn { background: var(--primary-grad); color: white; border: none; width: 34px; height: 34px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* CART BAR */
        .cart-bar { position: fixed; bottom: 20px; left: 50%; width: 92%; max-width: 500px; transform: translate(-50%, 150%); background: #1a1a1a; border-radius: 18px; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 1000; transition: transform 0.3s; }
        .cart-bar.active { transform: translate(-50%, 0); }
        .checkout-btn { background: var(--primary-grad); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 800; cursor: pointer; }
        
        /* POPUP */
        .popup { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 2000; align-items: flex-end; }
        .popup-content { background: #fff; width: 100%; max-width: 500px; margin: 0 auto; border-radius: 25px 25px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #f1f1f1; border-radius: 12px; margin-bottom: 10px; font-family: inherit; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary-red); }
        label { font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        /* STYLE TOMBOL PEMBAYARAN */
        .pay-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .pay-btn { flex: 1; padding: 12px; border: 2px solid #f1f1f1; border-radius: 12px; background: #fff; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.3s; }
        .pay-btn.selected { background: #e8f0fe; border-color: #3a86ff; color: #3a86ff; }

        .gps-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: #e1f5fe; color: #0288d1; border: 1px solid #b3e5fc; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 15px; font-size: 13px; }
        
        .qty-control { display: flex; align-items: center; gap: 12px; background: #f1f1f1; padding: 6px 12px; border-radius: 25px; }
        .qty-btn { background: none; border: none; color: var(--primary-red); font-weight: 800; font-size: 18px; cursor: pointer; padding: 0 5px; }
        
        .payment-summary { background: #fff9f9; border-radius: 12px; padding: 12px; margin: 15px 0; border: 1px dashed #ffcccc; }
        .summary-line { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .summary-line.total { border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; font-weight: 800; font-size: 16px; color: var(--primary-red); }
        .btn-selesai { width: 100%; background: var(--accent-grad); color: #1d3924; border: none; padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <h1 class="main-logo-text">Lesehan Macca</h1>
    <p>Lezat ‚Ä¢ Cepat ‚Ä¢ Bersahabat</p>
</header>

<div class="tabs-container">
    <button class="tab-link active" onclick="openTab(event, 'paket')">‚≠ê Paket</button>
    <button class="tab-link" onclick="openTab(event, 'ayam')">üçó Ayam</button>
    <button class="tab-link" onclick="openTab(event, 'ikan')">üêü Ikan</button>
    <button class="tab-link" onclick="openTab(event, 'seafood')">üç§ Seafood</button>
    <button class="tab-link" onclick="openTab(event, 'nasimie')">üçö Nasi & Mie</button>
    <button class="tab-link" onclick="openTab(event, 'lauk')">ü•¨ Sayur & Lauk</button>
</div>

<div class="container" id="menu-container"></div>

<div class="cart-bar" id="cartBar">
    <div><span id="itemCount" style="font-weight:800; background:#333; padding:4px 10px; border-radius:8px; margin-right:8px;">0</span><strong id="totalText">Rp 0</strong></div>
    <button class="checkout-btn" onclick="openPopup()">Review Pesanan</button>
</div>

<div class="popup" id="popup">
    <div class="popup-content">
        <h3 style="margin-top:0; font-size:18px;">Detail Pengiriman</h3>
        <input id="nama" type="text" placeholder="Nama Penerima">
        <input id="telp" type="tel" placeholder="Nomor WhatsApp">
        <button class="gps-btn" onclick="getLocation()"><span id="gpsStatus">üìç Klik Untuk Kirim Lokasi GPS</span></button>
        <textarea id="alamat" rows="2" placeholder="Alamat lengkap / Patokan rumah"></textarea>
        
        <label>Metode Pembayaran</label>
        <div class="pay-group">
            <button class="pay-btn selected" id="btn-cod" onclick="setPayment('COD')">COD</button>
            <button class="pay-btn" id="btn-tf" onclick="setPayment('Transfer Bank')">TRANSFER / QRIS</button>
        </div>

        <div id="cartList" style="max-height: 180px; overflow-y: auto; margin-bottom:10px;"></div>
        
        <div class="payment-summary">
            <div class="summary-line"><span>Subtotal</span><span id="subtotalText">Rp 0</span></div>
            <div class="summary-line" id="ongkirLine"><span>Ongkir</span><span>Rp 5.000</span></div>
            <div class="summary-line total"><span>Total Akhir</span><span id="popupTotal">Rp 0</span></div>
        </div>
        <button id="btnFinal" class="btn-selesai" onclick="simpanKeFirebase()">SELESAIKAN PESANAN</button>
        <button onclick="closePopup()" style="width:100%; background:none; border:none; color:#999; margin-top:12px; padding:10px;">Kembali</button>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBjEI1iiOjfrpyaZzEntRCGuiiorgxol0", 
        databaseURL: "https://lesehan-macca-new-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const menuData = {
        paket: { title: "Paket Macca Hemat", items: [
            { name: "P.H Ayam Bakar + Es Teh", price: 22000, img: "https://images.unsplash.com/photo-1626074353765-517a681e40be?w=200" },
            { name: "P.H Bandeng Bakar + Es Teh", price: 20000, img: "https://images.unsplash.com/photo-1585032226651-759b368d7246?w=200" },
            { name: "P.H Ayam Bakar + Sayur", price: 22000, img: "https://images.unsplash.com/photo-1598515214211-89d3c73ae83b?w=200" }
        ]},
        ayam: { title: "Olahan Ayam", items: [
            { name: "Ayam Bakar Rica/Biasa", price: 14000, img: "https://images.unsplash.com/photo-1598515214211-89d3c73ae83b?w=200" },
            { name: "Ayam Goreng Rica/Biasa", price: 14000, img: "https://images.unsplash.com/photo-1562967914-608f82629710?w=200" },
            { name: "Ayam Goreng Tepung", price: 16000, img: "https://images.unsplash.com/photo-1562967915-92ae0c33c0d0?w=200" },
            { name: "Ayam Saos Mentega", price: 17000, img: "https://images.unsplash.com/photo-1604908177453-7462950a6a3b?w=200" }
        ]},
        ikan: { title: "Olahan Ikan", items: [
            { name: "Bandeng Bakar", price: 13000, img: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=200" },
            { name: "Bandeng Goreng", price: 13000, img: "https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?w=200" },
            { name: "Bandeng Pallumara", price: 20000, img: "https://images.unsplash.com/photo-1534604973900-c41ab4c94f7b?w=200" },
            { name: "Ikan Layang Bakar/Goreng", price: 15000, img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=200" },
            { name: "Kakap/Katamba Bakar", price: 30000, img: "https://images.unsplash.com/photo-1559737558-2f5a35f4523b?w=200" }
        ]},
        seafood: { title: "Olahan Cumi & Udang", items: [
            { name: "Cumi Bakar", price: 28000, img: "https://images.unsplash.com/photo-1590594460041-99625355a244?w=200" },
            { name: "Cumi Goreng Tepung", price: 30000, img: "https://images.unsplash.com/photo-1590594460041-99625355a244?w=200" },
            { name: "Udang Bakar", price: 28000, img: "https://images.unsplash.com/photo-1559742811-824289511f48?w=200" },
            { name: "Udang Saos Pedas", price: 30000, img: "https://images.unsplash.com/photo-1535400255456-984241443b29?w=200" }
        ]},
        nasimie: { title: "Nasi & Mie Goreng", items: [
            { name: "Nasi Goreng Jakarta", price: 18000, img: "https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=200" },
            { name: "Mie Goreng Biasa", price: 15000, img: "https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=200" },
            { name: "Mie Kering Ayam", price: 23000, img: "https://images.unsplash.com/photo-1612929633738-8fe44f7ec841?w=200" },
            { name: "Nasi Putih", price: 5000, img: "https://images.unsplash.com/photo-1516684732162-798a0062be99?w=200" }
        ]},
        lauk: { title: "Sayur & Lauk", items: [
            { name: "Sayur Sup / Santan", price: 7000, img: "https://images.unsplash.com/photo-1547592166-23ac45744acd?w=200" },
            { name: "Kangkung/Sawi/Paria Cah", price: 8000, img: "https://images.unsplash.com/photo-1546833998-877b37c2e5c6?w=200" },
            { name: "Tahu Goreng Biasa", price: 7000, img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=200" },
            { name: "Tempe Goreng Biasa", price: 7000, img: "https://images.unsplash.com/photo-1562967914-608f82629710?w=200" }
        ]}
    };

    let cart = [];
    let gpsLink = "";
    let selectedPayment = "COD";

    function initMenu() {
        const container = document.getElementById('menu-container');
        container.innerHTML = "";
        for (const key in menuData) {
            let html = `<div id="${key}" class="menu-section ${key === 'paket' ? 'active' : ''}">
                <div class="section-title">${menuData[key].title}</div><div class="menu-grid">`;
            menuData[key].items.forEach(item => {
                html += `<div class="menu-card"><img src="${item.img}" class="product-img"><div class="menu-info"><h4>${item.name}</h4><p>Rp ${item.price.toLocaleString()}</p></div>
                <button class="add-btn" onclick="addItem('${item.name}', ${item.price})">+</button></div>`;
            });
            container.innerHTML += html + `</div></div>`;
        }
    }

    function openTab(e, id) {
        document.querySelectorAll(".menu-section, .tab-link").forEach(x => x.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        e.currentTarget.classList.add("active");
    }

    // FUNGSI ADD ITEM YANG DIPERBAIKI
    function addItem(name, price) { 
        cart.push({name, price}); 
        updateUI(); 
        if(document.getElementById('popup').style.display === 'flex') renderCart(); 
    }
    
    // FUNGSI REMOVE ITEM YANG DIPERBAIKI
    function removeItem(name) { 
        const i = cart.findIndex(x => x.name === name); 
        if(i > -1) { 
            cart.splice(i, 1); 
            updateUI(); 
            renderCart(); 
        } 
    }

    function updateUI() {
        const total = cart.reduce((s, x) => s + x.price, 0);
        const bar = document.getElementById('cartBar');
        bar.classList.toggle('active', cart.length > 0);
        document.getElementById('totalText').innerText = `Rp ${total.toLocaleString()}`;
        document.getElementById('itemCount').innerText = cart.length;
    }

    function setPayment(val) {
        selectedPayment = val;
        document.getElementById('btn-cod').classList.toggle('selected', val === 'COD');
        document.getElementById('btn-tf').classList.toggle('selected', val === 'Transfer Bank');
        renderCart();
    }

    function openPopup() { 
        if(cart.length === 0) return;
        renderCart(); 
        document.getElementById('popup').style.display = 'flex'; 
    }
    function closePopup() { document.getElementById('popup').style.display = 'none'; }

    function renderCart() {
        const list = document.getElementById('cartList'); 
        list.innerHTML = ''; 
        let sub = 0;
        const sum = {}; 
        
        cart.forEach(x => { 
            sum[x.name] = sum[x.name] || { p: x.price, q: 0 }; 
            sum[x.name].q++; 
            sub += x.price; 
        });

        for (const n in sum) {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                <div style="font-size:13px; font-weight:600; flex:1;">${n}</div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="removeItem('${n}')">‚àí</button>
                    <span style="font-weight:700; font-size:14px; min-width:20px; text-align:center;">${sum[n].q}</span>
                    <button class="qty-btn" onclick="addItem('${n}', ${sum[n].p})">+</button>
                </div>
            </div>`;
        }
        
        const isCOD = selectedPayment === 'COD';
        document.getElementById('subtotalText').innerText = `Rp ${sub.toLocaleString()}`;
        document.getElementById('ongkirLine').style.display = isCOD ? 'flex' : 'none';
        document.getElementById('popupTotal').innerText = `Rp ${(sub + (isCOD ? 5000 : 0)).toLocaleString()}`;
        
        // Sembunyikan popup jika keranjang kosong setelah dikurangi
        if(cart.length === 0) closePopup();
    }

    function getLocation() {
        if (!navigator.geolocation) return alert("GPS tidak didukung");
        document.getElementById('gpsStatus').innerText = "‚è≥ Mencari Lokasi...";
        navigator.geolocation.getCurrentPosition(p => {
            gpsLink = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            document.getElementById('gpsStatus').innerText = "‚úÖ Lokasi Terkunci";
        }, () => {
            alert("Gagal ambil GPS. Pastikan izin lokasi aktif.");
            document.getElementById('gpsStatus').innerText = "‚ùå Gagal Ambil Lokasi";
        });
    }

    function simpanKeFirebase() {
        const n = document.getElementById('nama').value.trim();
        const w = document.getElementById('telp').value.trim();
        const a = document.getElementById('alamat').value.trim();
        const btn = document.getElementById('btnFinal');

        if(!n || !w || !a) return Swal.fire('Oops!', 'Mohon lengkapi Nama, WhatsApp, dan Alamat!', 'warning');
        if(cart.length === 0) return Swal.fire('Oops!', 'Keranjang kosong!', 'warning');

        btn.disabled = true;
        btn.innerText = "MENGIRIM...";

        const sum = {}; cart.forEach(x => { sum[x.name] = (sum[x.name] || 0) + 1; });
        let detailOrder = "";
        for(let k in sum) detailOrder += `${k} (x${sum[k]})\n`;

        const orderData = {
            customer: n,
            whatsapp: w,
            alamat: a,
            gps: gpsLink || "Tidak kirim lokasi",
            pembayaran: selectedPayment,
            items: detailOrder.trim(),
            total: document.getElementById('popupTotal').innerText,
            orderType: "ANTAR", // INI PENTING: Agar Driver bisa melihat
            status: 'new',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref('orders').push(orderData).then(() => {
            closePopup();
            Swal.fire({
                title: 'Berhasil!',
                text: 'Pesanan Anda telah terkirim.',
                icon: 'success',
                confirmButtonColor: '#8B1A1A'
            }).then(() => { 
                cart = []; 
                updateUI();
                document.getElementById('nama').value = "";
                document.getElementById('telp').value = "";
                document.getElementById('alamat').value = "";
                btn.disabled = false;
                btn.innerText = "SELESAIKAN PESANAN";
            });
        }).catch(err => {
            btn.disabled = false;
            btn.innerText = "SELESAIKAN PESANAN";
            Swal.fire('Error', 'Gagal mengirim pesanan.', 'error');
        });
    }

    window.onload = initMenu;
</script>
</body>
</html>
